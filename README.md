# **Тестовое задание на стажировку в ВК**

## **Описание**

Этот приложение представляет собой gRPC-сервер для публикации и подписки на события с использованием пакета `subpub`. Сервис предоставляет следующие возможности:
- **Публикация событий**: Отправка сообщений в топик по указанному ключу.
- **Подписка на события**: Получение потока данных по указанному названию топика.

Используемый protobuf-контракт лежит по пути `api/subpub.proto`

## Метод Subscribe
- **Клиент посылает запрос и получает обратно поток данных**
- **При разрыве соединения подписка удаляется**
### Пример запроса
```
{
    "key": "subject1234"
}
```
### Пример ответа
```
{}
```
## Метод Publish
- **Клиент отправляет определенное сообщение всем подписчикам в указанном топике**
### Пример запроса
```
{
    "data": "my message",
    "key": "subject1234"
}
```
## Особенности
- **Проект разделен на слои: слой с gRPC-хендлерами и слой с бизнес-логикой**
- **Применено Dependency injection (используется интерфейс для связи пакета subpub и gRPC-сервера)**
- **В проекте логгируются события**
- **В приложении предусмотрен Graceful shutdown, который завершает работу сервиса SubPub и gRPC-сервера**
- **Используется файл с конфигом и библиотека [viper](https://github.com/spf13/viper) для настройки параметров запуска**

## **Основные компоненты:**

1. **SubPub – структура сервиса:**
   - Хранит подписчиков в map[string]map[*subscriber]struct{} (группировка по темам).
   - Использует RWMutex для потокобезопасности.
   - Поддерживает graceful shutdown через context.Context.

2. **Подписка (Subscribe):**

   - Создает подписчика с буферизированным каналом (bufferSize = 64).
   - Запускает горутину для обработки сообщений через MessageHandler.
   - Отписка (Unsubscribe) удаляет подписчика и закрывает канал (гарантированно 1 раз).

3. **Публикация (Publish):**
   - Рассылает сообщение всем подписчикам темы.
   - Если буфер подписчика переполнен, отправка происходит асинхронно.

4. **Закрытие (Close):**
     - Завершает все подписки.
     - Дожидается обработки оставшихся сообщений (sync.WaitGroup).
     - Поддерживает отмену через контекст.

5. **Тесты**
    - Пакет покрыт unit-тестами

6. **Graceful Shutdown:**
    - Поддержка корректного завершения работы с использованием контекста (`context.Context`).

## Сборка

Сборка в контейнере осуществляется при помощи `Docker`.
В `Makefile` прописаны короткие инструкции для запуска.

Шаг 1. Склонировать репозиторий себе локально и перейти в него:

```
git clone https://github.com/AnikinSimon/vk-test-task.git
cd vk-test-task
```

Шаг 2. Для запуска сервиса:

```
make run
```

или
```
docker compose up --build -d
```
Шаг 3. Для остановки сервиса после работы нужно выполнить:
```
make stop
```
или
```
docker compose down
```

## Тестировние
Чтобы запустить unit-тесты, выполните:
```
make unit
```
